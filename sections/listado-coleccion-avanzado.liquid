<section class="product-trust-section" style="background-color: {{ section.settings.bg_color }};">
  <div class="product-trust-container">
    {% if section.settings.main_title != blank %}
      <h2 class="section-main-title">{{ section.settings.main_title }}</h2>
    {% endif %}

    <div class="product-trust-grid">
      {% for block in section.blocks %}
        {%- assign product_ref = block.settings.featured_product -%}
        
        <div class="product-trust-card" {{ block.shopify_attributes }}>
          {% if product_ref != blank %}
            <div class="product-trust-image-wrapper">
              <a href="{{ product_ref.url }}">
                <img class="primary-img" src="{{ product_ref.featured_image | img_url: '500x500', crop: 'center' }}" alt="{{ product_ref.title }}">
                {% if product_ref.images[1] != blank %}
                   <img class="secondary-img" src="{{ product_ref.images[1] | img_url: '500x500', crop: 'center' }}" alt="{{ product_ref.title }}">
                {% endif %}
              </a>
              {% if block.settings.badge_text != blank %}
                <span class="trust-badge">{{ block.settings.badge_text }}</span>
              {% endif %}
            </div>

            <div class="product-trust-info">
              <h3 class="product-title"><a href="{{ product_ref.url }}">{{ product_ref.title }}</a></h3>
              <div class="product-price-row">
                <span class="product-price">{{ product_ref.price | money }}</span>
                {% if product_ref.compare_at_price > product_ref.price %}
                  <span class="product-compare-price">{{ product_ref.compare_at_price | money }}</span>
                {% endif %}
              </div>
              
              {% comment %} Formulario con AJAX {% endcomment %}
              <div class="product-form-container">
                <input type="number" id="qty-{{ block.id }}" name="quantity" value="1" min="1" class="qty-input">
                <button type="button" 
                        class="add-to-cart-btn-ajax" 
                        onclick="addToCartAjax('{{ product_ref.variants.first.id }}', 'qty-{{ block.id }}', this)">
                  <span class="btn-label">{{ section.settings.btn_label }}</span>
                  <span class="loading-spinner" style="display:none;">⏳</span>
                </button>
              </div>
            </div>
          {% else %}
            <div class="product-placeholder">
              <p>Selecciona un producto en el panel lateral</p>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<style>
  .product-trust-section { padding: 80px 20px; font-family: sans-serif; }
  .product-trust-container { max-width: 1300px; margin: 0 auto; }
  .section-main-title { margin-bottom: 50px; font-size: 32px; font-weight: 800; text-align: center; }
  
  .product-trust-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
  }

  .product-trust-card {
    background: #fff;
    border-radius: 12px;
    transition: all 0.3s ease;
    border: 1px solid #f0f0f0;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  /* Efecto de Imagen Doble */
  .product-trust-image-wrapper {
    position: relative;
    overflow: hidden;
    aspect-ratio: 1/1;
    border-radius: 12px 12px 0 0;
  }
  .product-trust-image-wrapper img {
    width: 100%; height: 100%; object-fit: cover;
    transition: transform 0.8s ease, opacity 0.5s ease;
  }
  .secondary-img {
    position: absolute; top: 0; left: 0; opacity: 0;
  }
  .product-trust-card:hover .secondary-img { opacity: 1; }
  .product-trust-card:hover .primary-img { opacity: 0; transform: scale(1.1); }

  .product-trust-info { padding: 25px; }

  .trust-badge {
    position: absolute; top: 15px; left: 15px;
    background: {{ section.settings.accent_color }};
    color: #fff; font-size: 11px; padding: 5px 12px;
    border-radius: 50px; font-weight: bold; z-index: 2;
  }

  .product-title a { text-decoration: none; color: #111; font-size: 19px; font-weight: 700; }
  
  .product-price-row { margin: 10px 0 20px; display: flex; gap: 10px; align-items: center; }
  .product-price { font-size: 18px; font-weight: 600; color: {{ section.settings.accent_color }}; }
  .product-compare-price { text-decoration: line-through; color: #999; font-size: 15px; }

  /* Controles de Compra */
  .product-form-container { display: flex; gap: 10px; }
  .qty-input {
    width: 60px; border: 1px solid #ddd; border-radius: 8px;
    text-align: center; font-weight: bold;
  }
  .add-to-cart-btn-ajax {
    flex-grow: 1; padding: 14px; background: #000; color: #fff;
    border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
    transition: background 0.3s;
  }
  .add-to-cart-btn-ajax:hover { background: #333; }

  .product-placeholder { padding: 60px; text-align: center; border: 2px dashed #ddd; border-radius: 12px; }
</style>

<script>
function addToCartAjax(variantId, qtyId, btn) {
  const qty = document.getElementById(qtyId).value;
  const label = btn.querySelector('.btn-label');
  const spinner = btn.querySelector('.loading-spinner');

  label.style.display = 'none';
  spinner.style.display = 'inline-block';

  let formData = {
   'items': [{ 'id': variantId, 'quantity': qty }]
  };

  fetch(window.Shopify.routes.root + 'cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(response => {
    return response.json();
  })
  .then(data => {
    spinner.style.display = 'none';
    label.style.display = 'inline-block';
    label.innerText = "¡AÑADIDO! ✓";
    btn.style.background = "#27ae60";
    
    // Abrir el carrito automáticamente si tu tema lo permite
    if(document.querySelector('cart-drawer')) {
       document.querySelector('cart-drawer').classList.add('active');
    }

    setTimeout(() => {
      label.innerText = "{{ section.settings.btn_label }}";
      btn.style.background = "#000";
    }, 2000);
  })
  .catch((error) => {
    console.error('Error:', error);
    alert('Hubo un error al añadir al carrito');
  });
}
</script>

{% schema %}
{
  "name": "Quick Buy Pro",
  "settings": [
    { "type": "text", "id": "main_title", "label": "Título Principal", "default": "Selección Premium" },
    { "type": "color", "id": "bg_color", "label": "Fondo", "default": "#ffffff" },
    { "type": "color", "id": "accent_color", "label": "Color Acento", "default": "#000000" },
    { "type": "text", "id": "btn_label", "label": "Botón", "default": "COMPRA RÁPIDA" }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Producto",
      "settings": [
        { "type": "product", "id": "featured_product", "label": "Producto" },
        { "type": "text", "id": "badge_text", "label": "Badge", "default": "HOT" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Quick Buy Pro",
      "blocks": [ { "type": "product" }, { "type": "product" }, { "type": "product" } ]
    }
  ]
}
{% endschema %}