<div class="ai-launcher" onclick="toggleAIChat()" id="aiLauncher">
  <div class="ai-pulse"></div>
  <svg viewBox="0 0 24 24">
    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-10a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm11 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm-4.5 4.5c-1.66 0-3-1.34-3-3H7c0 2.76 2.24 5 5 5s5-2.24 5-5h-3c0 1.66-1.34 3-3 3z"/>
  </svg>
</div>

<div id="ai-chat-box" class="ai-window">
  <div class="ai-header">
    <div class="ai-status">
      <div class="status-indicator"></div>
      <span>KIESLECT NEURAL CORE V.2</span>
    </div>
    <button onclick="toggleAIChat()" class="close-ai">✕</button>
  </div>
  
  <div id="ai-messages" class="ai-body">
    <div class="ai-msg bot">
      <small>SYSTEM ONLINE</small>
      Hola, soy el núcleo de asistencia Kieslect. He analizado tu navegación actual. ¿Cómo puedo asesorarte con nuestra tecnología wearable?
    </div>
  </div>

  <div class="ai-typing" id="aiTyping" style="display:none;">
    <span></span><span></span><span></span>
  </div>

  <div class="ai-footer">
    <input type="text" id="ai-input" placeholder="Escribe tu duda técnica..." onkeypress="handleEnter(event)">
    <button onclick="askAI()" id="sendBtn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
    </button>
  </div>
</div>

<style>
  :root { 
    --k-neon: #00D1FF; 
    --k-dark: #0d0d0d;
    --k-glass: rgba(255, 255, 255, 0.05);
  }

  .ai-launcher {
    position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px;
    background: var(--k-dark); border: 2px solid var(--k-neon); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    z-index: 10000; box-shadow: 0 0 25px rgba(0,209,255,0.3);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .ai-launcher:hover { transform: scale(1.1) rotate(15deg); }
  .ai-launcher svg { width: 32px; fill: var(--k-neon); filter: drop-shadow(0 0 5px var(--k-neon)); }

  .ai-pulse {
    position: absolute; width: 100%; height: 100%;
    border: 2px solid var(--k-neon); border-radius: 50%;
    animation: k-pulse-expand 2s infinite;
  }

  .ai-window {
    position: fixed; bottom: 110px; right: 30px; width: 380px; height: 550px;
    background: var(--k-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
    display: none; flex-direction: column; z-index: 10000; overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  }

  .ai-header { padding: 20px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
  .ai-status { display: flex; align-items: center; gap: 10px; font-size: 10px; font-weight: 900; letter-spacing: 2px; color: var(--k-neon); }
  .status-indicator { width: 8px; height: 8px; background: var(--k-neon); border-radius: 50%; box-shadow: 0 0 10px var(--k-neon); animation: blink 1s infinite; }
  .close-ai { color: #fff; opacity: 0.5; cursor: pointer; font-size: 18px; border: none; background: none; }
  .ai-body { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scrollbar-width: thin; }
  .ai-msg { padding: 12px 18px; border-radius: 18px; font-size: 14px; max-width: 85%; line-height: 1.5; position: relative; }
  .ai-msg.bot { background: var(--k-glass); color: #eee; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
  .ai-msg.bot small { display: block; font-size: 8px; color: var(--k-neon); margin-bottom: 5px; font-weight: 800; }
  .ai-msg.user { background: var(--k-neon); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 600; }
  .ai-typing { padding: 10px 20px; display: flex; gap: 5px; }
  .ai-typing span { width: 6px; height: 6px; background: var(--k-neon); border-radius: 50%; animation: type-bounce 1s infinite; }
  .ai-footer { padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
  .ai-footer input { flex-grow: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 15px; color: #fff; outline: none; }

  @keyframes k-pulse-expand { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.6); opacity: 0; } }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  @keyframes type-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  @media (max-width: 480px) { .ai-window { width: calc(100% - 40px); right: 20px; left: 20px; bottom: 100px; height: 70vh; } }
</style>

<script>
  function toggleAIChat() {
    const chat = document.getElementById('ai-chat-box');
    chat.style.display = (chat.style.display === 'flex') ? 'none' : 'flex';
  }

  function handleEnter(e) { if (e.key === 'Enter') askAI(); }

  // Función para localizar en qué sección está el usuario
  function getCurrentSection() {
    const sections = document.querySelectorAll('section, .shopify-section');
    let currentSection = "la tienda";
    
    sections.forEach(section => {
      const rect = section.getBoundingClientRect();
      if (rect.top >= 0 && rect.top <= window.innerHeight / 2) {
        currentSection = section.innerText.split('\n')[0] || "esta sección";
      }
    });
    return currentSection;
  }

  function askAI() {
    const input = document.getElementById('ai-input');
    const msgContainer = document.getElementById('ai-messages');
    const typing = document.getElementById('aiTyping');
    
    if (input.value.trim() === "") return;

    const userMsg = input.value;
    const userQuery = userMsg.toLowerCase();
    
    // Añadir mensaje usuario
    const userDiv = document.createElement('div');
    userDiv.className = 'ai-msg user';
    userDiv.innerText = userMsg;
    msgContainer.appendChild(userDiv);
    
    input.value = "";
    msgContainer.scrollTop = msgContainer.scrollHeight;
    typing.style.display = 'flex';

    setTimeout(() => {
      typing.style.display = 'none';
      const botDiv = document.createElement('div');
      botDiv.className = 'ai-msg bot';
      
      let response = "";
      const currentLoc = getCurrentSection();

      // LÓGICA DE ASESORÍA Y LOCALIZACIÓN
      if (userQuery.includes("donde estoy") || userQuery.includes("seccion")) {
        response = `Detecto que te encuentras explorando: **${currentLoc}**. ¿Deseas que te explique los beneficios de los productos en esta área?`;
      } 
      else if (userQuery.includes("recomienda") || userQuery.includes("mejor")) {
        response = "Como tu asistente neural, te sugiero el **Kieslect KS Pro** si buscas llamadas estables y gran pantalla, o el **Lora 2** si prefieres elegancia y ligereza. ¿Cuál se adapta mejor a tu ritmo?";
      }
      else if (userQuery.includes("bateria") || userQuery.includes("dura")) {
        response = "La mayoría de nuestros núcleos (smartwatches) ofrecen entre 5 a 7 días de uso intensivo. ¿Te preocupa el rendimiento para algún deporte en específico?";
      }
      else if (userQuery.includes("agua") || userQuery.includes("piscina")) {
        response = "Muchos de nuestros modelos cuentan con certificación IP68. Son resistentes al sudor y salpicaduras, ideales para el entrenamiento diario.";
      }
      else if (userQuery.includes("precio") || userQuery.includes("vale")) {
        response = `Actualmente estás viendo ${currentLoc}. Los precios varían según la tecnología, pero tenemos opciones desde los $40 USD con envíos locales.`;
      }
      else if (userQuery.includes("hola") || userQuery.includes("ayuda")) {
        response = "Conexión establecida. Estoy listo para asesorarte sobre sensores de salud, modos deportivos o compatibilidad con tu smartphone.";
      }
      else {
        response = "Interesante pregunta. Desde la perspectiva de Kieslect, optimizamos cada wearable para tu estilo de vida. ¿Podrías darme más detalles para darte una respuesta técnica precisa?";
      }

      botDiv.innerHTML = `<small>NEURAL ADVISOR RESPONSE</small>${response}`;
      msgContainer.appendChild(botDiv);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }, 1